@page "/"
@page "/home"
@inject NavigationManager Navigation
@inject AccountingPro.Application.Services.IDashboardService DashboardService
@inject AccountingPro.Application.Services.ICompanyContextService CompanyContext

<PageTitle>Dashboard - AccountingPro</PageTitle>

<!-- Hero Section -->
<div class="hero-section">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1 class="hero-title">
                    <i class="fas fa-chart-line text-primary"></i>
                    AccountingPro Dashboard
                </h1>
                <p class="hero-subtitle">Complete business management solution at your fingertips</p>
                <div class="hero-actions mt-4">
                    <button class="btn btn-primary btn-lg me-3" @onclick="NavigateToInvoices">
                        <i class="fas fa-file-invoice-dollar"></i> Create Invoice
                    </button>
                    <button class="btn btn-success btn-lg me-3" @onclick="NavigateToCustomers">
                        <i class="fas fa-users"></i> Manage Customers
                    </button>
                    <button class="btn btn-info btn-lg" @onclick="NavigateToReports">
                        <i class="fas fa-chart-bar"></i> View Reports
                    </button>
                </div>
            </div>
            <div class="col-lg-4 text-center">
                <div class="hero-graphic">
                    <i class="fas fa-calculator hero-icon"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Key Metrics Section -->
@if (isLoading)
{
    <div class="metrics-section">
        <div class="container-fluid">
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading dashboard...</p>
            </div>
        </div>
    </div>
}
else if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="metrics-section">
        <div class="container-fluid">
            <div class="alert alert-warning text-center">
                <i class="fas fa-exclamation-triangle"></i>
                @errorMessage
            </div>
        </div>
    </div>
}
else
{
<div class="metrics-section">
    <div class="container-fluid">
        <h2 class="section-title mb-5">
            <i class="fas fa-tachometer-alt"></i> Business Overview
        </h2>
        <div class="row g-4">
            <div class="col-xl-3 col-lg-6">
                <div class="metric-card revenue-card">
                    <div class="metric-header">
                        <div class="metric-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="metric-trend">
                            <span class="trend-up">@(metrics?.TotalInvoicesCount ?? 0) invoices</span>
                        </div>
                    </div>
                    <div class="metric-body">
                        <h3 class="metric-value">@(metrics?.TotalRevenue.ToString("C") ?? "$0.00")</h3>
                        <p class="metric-label">Total Revenue</p>
                        <small class="metric-detail">This month</small>
                    </div>
                    <div class="metric-footer">
                        <button class="btn btn-sm btn-outline-light" @onclick="NavigateToReports">
                            View Details
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-lg-6">
                <div class="metric-card expenses-card">
                    <div class="metric-header">
                        <div class="metric-icon">
                            <i class="fas fa-credit-card"></i>
                        </div>
                        <div class="metric-trend">
                            <span class="trend-down">@(metrics?.TotalCustomersCount ?? 0) customers</span>
                        </div>
                    </div>
                    <div class="metric-body">
                        <h3 class="metric-value">@(metrics?.TotalExpenses.ToString("C") ?? "$0.00")</h3>
                        <p class="metric-label">Total Expenses</p>
                        <small class="metric-detail">This month</small>
                    </div>
                    <div class="metric-footer">
                        <button class="btn btn-sm btn-outline-light" @onclick="NavigateToBills">
                            Manage Bills
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-lg-6">
                <div class="metric-card invoices-card">
                    <div class="metric-header">
                        <div class="metric-icon">
                            <i class="fas fa-file-invoice"></i>
                        </div>
                        <div class="metric-trend">
                            <span class="trend-warning">@(metrics?.PendingInvoicesCount ?? 0)</span>
                        </div>
                    </div>
                    <div class="metric-body">
                        <h3 class="metric-value">@(metrics?.OutstandingInvoices.ToString("C") ?? "$0.00")</h3>
                        <p class="metric-label">Outstanding</p>
                        <small class="metric-detail">@(metrics?.PendingInvoicesCount ?? 0) pending invoices</small>
                    </div>
                    <div class="metric-footer">
                        <button class="btn btn-sm btn-outline-light" @onclick="NavigateToInvoices">
                            View Invoices
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-lg-6">
                <div class="metric-card profit-card">
                    <div class="metric-header">
                        <div class="metric-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="metric-trend">
                            <span class="trend-up">@(metrics?.TotalProductsCount ?? 0) products</span>
                        </div>
                    </div>
                    <div class="metric-body">
                        <h3 class="metric-value">@(metrics?.NetProfit.ToString("C") ?? "$0.00")</h3>
                        <p class="metric-label">Net Profit</p>
                        <small class="metric-detail">This month</small>
                    </div>
                    <div class="metric-footer">
                        <button class="btn btn-sm btn-outline-light" @onclick="NavigateToReports">
                            P&L Report
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
}

<!-- Quick Actions Section -->
<div class="quick-actions-section">
    <div class="container-fluid">
        <h2 class="section-title mb-5">
            <i class="fas fa-bolt"></i> Quick Actions
        </h2>
        <div class="row g-4">
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="quick-action-card" @onclick="NavigateToInvoices">
                    <div class="action-icon invoice-action">
                        <i class="fas fa-file-invoice-dollar"></i>
                    </div>
                    <h5>Create Invoice</h5>
                    <p>Generate new invoices</p>
                </div>
            </div>
            
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="quick-action-card" @onclick="NavigateToCustomers">
                    <div class="action-icon customer-action">
                        <i class="fas fa-user-plus"></i>
                    </div>
                    <h5>Add Customer</h5>
                    <p>New customer record</p>
                </div>
            </div>
            
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="quick-action-card" @onclick="NavigateToBills">
                    <div class="action-icon bill-action">
                        <i class="fas fa-receipt"></i>
                    </div>
                    <h5>Record Bill</h5>
                    <p>Add supplier bills</p>
                </div>
            </div>
            
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="quick-action-card" @onclick="NavigateToProducts">
                    <div class="action-icon product-action">
                        <i class="fas fa-box"></i>
                    </div>
                    <h5>Add Product</h5>
                    <p>Manage inventory</p>
                </div>
            </div>
            
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="quick-action-card" @onclick="NavigateToSuppliers">
                    <div class="action-icon supplier-action">
                        <i class="fas fa-truck"></i>
                    </div>
                    <h5>Add Supplier</h5>
                    <p>Vendor management</p>
                </div>
            </div>
            
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="quick-action-card" @onclick="NavigateToReports">
                    <div class="action-icon report-action">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <h5>View Reports</h5>
                    <p>Financial analysis</p>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private AccountingPro.Application.Services.DashboardMetricsDto? metrics;
    private bool isLoading = true;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Ensure company context is initialized
            await CompanyContext.InitializeAsync();
            
            if (CompanyContext.CurrentCompanyId.HasValue)
            {
                metrics = await DashboardService.GetDashboardMetricsAsync();
            }
            else
            {
                errorMessage = "Please select a company to view dashboard metrics.";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Home: Error: {ex.Message}");
            errorMessage = "Unable to load dashboard metrics. Please try again.";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void NavigateToInvoices() => Navigation.NavigateTo("/invoices");
    private void NavigateToCustomers() => Navigation.NavigateTo("/customers");
    private void NavigateToReports() => Navigation.NavigateTo("/reports");
    private void NavigateToBills() => Navigation.NavigateTo("/bills");
    private void NavigateToProducts() => Navigation.NavigateTo("/products");
    private void NavigateToSuppliers() => Navigation.NavigateTo("/suppliers");
}
