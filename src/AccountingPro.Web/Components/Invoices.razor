@page "/invoices"
@using AccountingPro.Application.DTOs
@using AccountingPro.Core.Enums
@using AccountingPro.Application.Services
@inject IInvoiceService InvoiceService
@inject IProductService ProductService
@inject ICustomerService CustomerService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>Invoices - AccountingPro</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Invoice Management</h1>
    <div>
        <button class="btn btn-secondary me-2" @onclick="TestJavaScript">
            <i class="fas fa-code"></i> Test JS
        </button>
        <button class="btn btn-primary" @onclick="CreateNewInvoice">
            <i class="fas fa-plus"></i> Create Invoice
        </button>
    </div>
</div>

<!-- Invoice Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-icon invoices">üìÑ</div>
            <div class="stat-content">
                <h3>@invoices.Count</h3>
                <p>Total Invoices</p>
                <small>This month</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-icon revenue">üí∞</div>
            <div class="stat-content">
                <h3>@invoices.Sum(i => i.TotalAmount).ToString("C")</h3>
                <p>Total Amount</p>
                <small>All invoices</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-icon profit">üìà</div>
            <div class="stat-content">
                <h3>@invoices.Sum(i => i.PaidAmount).ToString("C")</h3>
                <p>Amount Paid</p>
                <small>Received payments</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-icon expenses">‚è∞</div>
            <div class="stat-content">
                <h3>@invoices.Sum(i => i.BalanceAmount).ToString("C")</h3>
                <p>Outstanding</p>
                <small class="text-warning">Pending payment</small>
            </div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="row mb-3">
    <div class="col-md-3">
        <input type="text" class="form-control" placeholder="Search invoices..." @bind="searchTerm" @oninput="FilterInvoices" />
    </div>
    <div class="col-md-2">
        <select class="form-control" @bind="selectedStatus" >
            <option value="">All Status</option>
            <option value="@InvoiceStatus.Draft">Draft</option>
            <option value="@InvoiceStatus.Sent">Sent</option>
            <option value="@InvoiceStatus.Paid">Paid</option>
            <option value="@InvoiceStatus.PartiallyPaid">Partially Paid</option>
            <option value="@InvoiceStatus.Overdue">Overdue</option>
            <option value="@InvoiceStatus.Cancelled">Cancelled</option>
        </select>
    </div>
    <div class="col-md-2">
        <select class="form-control" @bind="selectedCustomer" >
            <option value="">All Customers</option>
            @foreach (var customer in GetUniqueCustomers())
            {
                <option value="@customer.Key">@customer.Value</option>
            }
        </select>
    </div>
    <div class="col-md-2">
        <input type="date" class="form-control" @bind="fromDate"  />
    </div>
    <div class="col-md-2">
        <input type="date" class="form-control" @bind="toDate"  />
    </div>
</div>

<!-- Invoice List -->
<div class="table-responsive">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Invoice #</th>
                <th>Customer</th>
                <th>Date</th>
                <th>Due Date</th>
                <th>Amount</th>
                <th>Paid</th>
                <th>Balance</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @if (filteredInvoices.Any())
            {
                @foreach (var invoice in filteredInvoices)
                {
                    <tr>
                        <td>
                            <strong>@invoice.InvoiceNumber</strong>
                        </td>
                        <td>@invoice.CustomerName</td>
                        <td>@invoice.InvoiceDate.ToString("MMM dd, yyyy")</td>
                        <td>
                            <span class="@(invoice.DueDate < DateTime.Today && invoice.Status != InvoiceStatus.Paid ? "text-danger" : "")">
                                @invoice.DueDate.ToString("MMM dd, yyyy")
                            </span>
                        </td>
                        <td>@invoice.TotalAmount.ToString("C")</td>
                        <td>@invoice.PaidAmount.ToString("C")</td>
                        <td>
                            <span class="@(invoice.BalanceAmount > 0 ? "text-warning" : "text-success")">
                                @invoice.BalanceAmount.ToString("C")
                            </span>
                        </td>
                        <td>
                            <span class="badge badge-@GetStatusClass(invoice.Status)">
                                @invoice.Status
                            </span>
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-outline-primary" @onclick="() => ViewInvoice(invoice.Id)" title="View">
                                    <i class="fas fa-eye"></i>
                                </button>
                                @if (invoice.Status == InvoiceStatus.Draft)
                                {
                                    <button class="btn btn-sm btn-outline-secondary" @onclick="() => EditInvoice(invoice.Id)" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                }
                                @if (invoice.Status != InvoiceStatus.Paid && invoice.Status != InvoiceStatus.Cancelled)
                                {
                                    <button class="btn btn-sm btn-outline-success" @onclick="() => RecordPayment(invoice.Id)" title="Record Payment">
                                        <i class="fas fa-dollar-sign"></i>
                                    </button>
                                }
                                <button class="btn btn-sm btn-outline-info" @onclick="() => PrintInvoice(invoice.Id)" title="Print/PDF">
                                    <i class="fas fa-print"></i>
                                </button>
                                @if (invoice.Status == InvoiceStatus.Draft)
                                {
                                    <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteInvoice(invoice.Id)" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                }
                            </div>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="9" class="text-center text-muted">
                        <div class="py-4">
                            <i class="fas fa-file-invoice" style="font-size: 2rem; opacity: 0.3;"></i>
                            <p class="mt-2">No invoices found</p>
                            <button class="btn btn-primary" @onclick="CreateNewInvoice">Create Your First Invoice</button>
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- Payment Recording Modal -->
@if (showPaymentModal)
{
    <div class="modal fade show" style="display: block; background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Record Payment</h5>
                    <button type="button" class="btn-close" @onclick="ClosePaymentModal"></button>
                </div>
                <div class="modal-body">
                    <EditForm Model="paymentForm" OnValidSubmit="SavePayment">
                        <DataAnnotationsValidator />
                        <div class="mb-3">
                            <label class="form-label">Invoice: @selectedInvoice?.InvoiceNumber</label>
                            <div class="text-muted">
                                Customer: @selectedInvoice?.CustomerName<br/>
                                Amount Due: @selectedInvoice?.BalanceAmount.ToString("C")
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Payment Date *</label>
                            <InputDate class="form-control" @bind-Value="paymentForm.PaymentDate" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Amount *</label>
                            <InputNumber class="form-control" @bind-Value="paymentForm.Amount" />
                            <small class="form-text text-muted">Maximum: @selectedInvoice?.BalanceAmount.ToString("C")</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Payment Method *</label>
                            <InputSelect class="form-control" @bind-Value="paymentForm.PaymentMethod">
                                <option value="@PaymentMethod.Cash">Cash</option>
                                <option value="@PaymentMethod.Check">Check</option>
                                <option value="@PaymentMethod.CreditCard">Credit Card</option>
                                <option value="@PaymentMethod.BankTransfer">Bank Transfer</option>
                                <option value="@PaymentMethod.PayPal">PayPal</option>
                                <option value="@PaymentMethod.Other">Other</option>
                            </InputSelect>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Reference</label>
                            <InputText class="form-control" @bind-Value="paymentForm.Reference" placeholder="Check number, transaction ID, etc." />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notes</label>
                            <InputTextArea class="form-control" @bind-Value="paymentForm.Notes" rows="3" />
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @onclick="ClosePaymentModal">Cancel</button>
                            <button type="submit" class="btn btn-success">Record Payment</button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

<!-- Invoice View Modal -->
@if (showViewModal && viewInvoice != null)
{
    <div class="modal fade show" style="display: block; background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Invoice Details - @viewInvoice.InvoiceNumber</h5>
                    <button type="button" class="btn-close" @onclick="CloseViewModal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h6>Invoice Information</h6>
                            <p><strong>Invoice Number:</strong> @viewInvoice.InvoiceNumber</p>
                            <p><strong>Customer:</strong> @viewInvoice.CustomerName</p>
                            <p><strong>Status:</strong> 
                                <span class="badge badge-@GetStatusClass(viewInvoice.Status)">@viewInvoice.Status</span>
                            </p>
                            <p><strong>Invoice Date:</strong> @viewInvoice.InvoiceDate.ToString("MMMM dd, yyyy")</p>
                            <p><strong>Due Date:</strong> @viewInvoice.DueDate.ToString("MMMM dd, yyyy")</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Financial Summary</h6>
                            <p><strong>Subtotal:</strong> @viewInvoice.SubTotal.ToString("C")</p>
                            <p><strong>Tax Amount:</strong> @viewInvoice.TaxAmount.ToString("C")</p>
                            <p><strong>Discount:</strong> @viewInvoice.DiscountAmount.ToString("C")</p>
                            <p><strong>Total Amount:</strong> @viewInvoice.TotalAmount.ToString("C")</p>
                            <p><strong>Amount Paid:</strong> @viewInvoice.PaidAmount.ToString("C")</p>
                            <p><strong>Balance Due:</strong> @viewInvoice.BalanceAmount.ToString("C")</p>
                        </div>
                    </div>
                    
                    @if (!string.IsNullOrEmpty(viewInvoice.Description))
                    {
                        <div class="mb-3">
                            <h6>Description</h6>
                            <p>@viewInvoice.Description</p>
                        </div>
                    }
                    
                    <h6>Invoice Items</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Product/Service</th>
                                    <th>Description</th>
                                    <th>Quantity</th>
                                    <th>Unit Price</th>
                                    <th>Tax Rate</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in viewInvoice.Items)
                                {
                                    <tr>
                                        <td>@item.ProductName</td>
                                        <td>@item.Description</td>
                                        <td>@item.Quantity</td>
                                        <td>@item.UnitPrice.ToString("C")</td>
                                        <td>@item.TaxRate.ToString("P")</td>
                                        <td>@item.TotalPrice.ToString("C")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                    
                    @if (!string.IsNullOrEmpty(viewInvoice.Notes))
                    {
                        <div class="mb-3">
                            <h6>Notes</h6>
                            <p>@viewInvoice.Notes</p>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseViewModal">Close</button>
                    <button type="button" class="btn btn-primary" @onclick="() => PrintInvoice(viewInvoice.Id)">
                        <i class="fas fa-print"></i> Print Invoice
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Invoice Edit Modal -->
@if (showEditModal)
{
    <div class="modal fade show" style="display: block; background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Invoice - @editForm.InvoiceNumber</h5>
                    <button type="button" class="btn-close" @onclick="CloseEditModal"></button>
                </div>
                <EditForm Model="@editForm" OnValidSubmit="@SaveEditedInvoice">
                    <DataAnnotationsValidator />
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Customer</label>
                                    <select @bind="editForm.CustomerId" class="form-select" required>
                                        <option value="0">Select Customer</option>
                                        @foreach (var customer in GetCustomerOptions())
                                        {
                                            <option value="@customer.Key">@customer.Value</option>
                                        }
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Invoice Date</label>
                                    <input type="date" @bind="editForm.InvoiceDate" class="form-control" required />
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Description</label>
                                    <input type="text" @bind="editForm.Description" class="form-control" />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Status</label>
                                    <select @bind="editForm.Status" class="form-select">
                                        <option value="@InvoiceStatus.Draft">Draft</option>
                                        <option value="@InvoiceStatus.Sent">Sent</option>
                                        <option value="@InvoiceStatus.Cancelled">Cancelled</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notes</label>
                            <textarea @bind="editForm.Notes" class="form-control" rows="2"></textarea>
                        </div>
                        
                        <!-- Invoice Items -->
                        <h6>Invoice Items</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Product/Service</th>
                                        <th>Description</th>
                                        <th>Qty</th>
                                        <th>Unit Price</th>
                                        <th>Total</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @for (int i = 0; i < editForm.Items.Count; i++)
                                    {
                                        var index = i;
                                        <tr>
                                            <td>
                                                <select @bind="editForm.Items[index].ProductId" @bind:event="oninput" @onchange="e => UpdateEditProductSelection(index, e)" class="form-select form-select-sm">
                                                    <option value="0">Select Product</option>
                                                    @foreach (var product in GetProductOptions())
                                                    {
                                                        <option value="@product.Key">@product.Value</option>
                                                    }
                                                </select>
                                            </td>
                                            <td>
                                                <input type="text" @bind="editForm.Items[index].Description" class="form-control form-control-sm" />
                                            </td>
                                            <td>
                                                <input type="number" @bind="editForm.Items[index].Quantity" @oninput="e => UpdateEditItemQuantity(index, e)" class="form-control form-control-sm" min="1" />
                                            </td>
                                            <td>
                                                <input type="number" @bind="editForm.Items[index].UnitPrice" @oninput="e => UpdateEditItemPrice(index, e)" class="form-control form-control-sm" step="0.01" min="0" />
                                            </td>
                                            <td>
                                                <span class="fw-bold">@((editForm.Items[index].Quantity * editForm.Items[index].UnitPrice).ToString("C"))</span>
                                            </td>
                                            <td>
                                                <button type="button" class="btn btn-sm btn-danger" @onclick="() => RemoveEditInvoiceItem(index)">√ó</button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        <button type="button" class="btn btn-sm btn-success" @onclick="AddEditInvoiceItem">+ Add Item</button>
                        
                        <div class="row mt-3">
                            <div class="col-md-6 offset-md-6">
                                <div class="d-flex justify-content-between">
                                    <strong>Total: @GetEditInvoiceTotal().ToString("C")</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseEditModal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

<!-- Invoice Creation Modal -->
@if (showCreateModal)
{
    <div class="modal fade show" style="display: block; background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Invoice</h5>
                    <button type="button" class="btn-close" @onclick="CloseCreateModal"></button>
                </div>
                <EditForm Model="@createInvoiceForm" OnValidSubmit="@SaveInvoice">
                    <DataAnnotationsValidator />
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Customer</label>
                                    <select @bind="createInvoiceForm.CustomerId" class="form-select" required>
                                        <option value="0">Select Customer</option>
                                        @foreach (var customer in GetCustomerOptions())
                                        {
                                            <option value="@customer.Key">@customer.Value</option>
                                        }
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Invoice Date</label>
                                    <input type="date" @bind="createInvoiceForm.InvoiceDate" class="form-control" required />
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <input type="text" @bind="createInvoiceForm.Description" class="form-control" placeholder="Enter description" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notes</label>
                            <textarea @bind="createInvoiceForm.Notes" class="form-control" rows="2" placeholder="Enter any notes"></textarea>
                        </div>
                        
                        <!-- Invoice Items -->
                        <h6>Invoice Items</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Product/Service</th>
                                        <th>Description</th>
                                        <th>Qty</th>
                                        <th>Unit Price</th>
                                        <th>Tax Rate (%)</th>
                                        <th>Total</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @for (int i = 0; i < createInvoiceForm.Items.Count; i++)
                                    {
                                        var index = i;
                                        <tr>
                                            <td>
                                                <select @bind="createInvoiceForm.Items[index].ProductId" @bind:event="oninput" @onchange="e => UpdateProductSelection(index, e)" class="form-select form-select-sm">
                                                    <option value="0">Select Product</option>
                                                    @foreach (var product in GetProductOptions())
                                                    {
                                                        <option value="@product.Key">@product.Value</option>
                                                    }
                                                </select>
                                            </td>
                                            <td>
                                                <input type="text" @bind="createInvoiceForm.Items[index].Description" class="form-control form-control-sm" />
                                            </td>
                                            <td>
                                                <input type="number" @bind="createInvoiceForm.Items[index].Quantity" @oninput="e => UpdateItemQuantity(index, e)" class="form-control form-control-sm" min="1" />
                                            </td>
                                            <td>
                                                <input type="number" @bind="createInvoiceForm.Items[index].UnitPrice" @oninput="e => UpdateItemPrice(index, e)" class="form-control form-control-sm" step="0.01" min="0" />
                                            </td>
                                            <td>
                                                <input type="number" @bind="createInvoiceForm.Items[index].TaxRate" @oninput="e => UpdateItemTaxRate(index, e)" class="form-control form-control-sm" step="0.01" min="0" max="100" />
                                            </td>
                                            <td>
                                                <span class="fw-bold">@(GetItemTotal(createInvoiceForm.Items[index]).ToString("C"))</span>
                                            </td>
                                            <td>
                                                <button type="button" class="btn btn-sm btn-danger" @onclick="() => RemoveInvoiceItem(index)">√ó</button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        <button type="button" class="btn btn-sm btn-success" @onclick="AddInvoiceItem">+ Add Item</button>
                        
                        <div class="row mt-3">
                            <div class="col-md-6 offset-md-6">
                                <div class="d-flex justify-content-between">
                                    <strong>Total: @GetInvoiceTotal().ToString("C")</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseCreateModal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create Invoice</button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

@code {
    private List<InvoiceDto> invoices = new();
    private List<InvoiceDto> filteredInvoices = new();
    private string searchTerm = "";
    private string selectedStatus = "";
    private string selectedCustomer = "";
    private DateTime? fromDate;
    private DateTime? toDate;
    private bool showPaymentModal = false;
    private CreatePaymentDto paymentForm = new();
    private InvoiceDto? selectedInvoice;
    
    // Invoice creation variables
    private bool showCreateModal = false;
    private CreateInvoiceDto createInvoiceForm = new();
    private List<CustomerDto> customers = new();
    private List<ProductDto> products = new();

    // Invoice view/edit variables
    private bool showViewModal = false;
    private bool showEditModal = false;
    private InvoiceDto? viewInvoice;
    private EditInvoiceDto editForm = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadInvoices();
    }

    private async Task LoadInvoices()
    {
        try
        {
            invoices = await InvoiceService.GetAllInvoicesAsync();
            filteredInvoices = invoices.ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading invoices: {ex.Message}");
            invoices = new List<InvoiceDto>();
            filteredInvoices = new List<InvoiceDto>();
        }
        
        // Load sample customers and products for creating invoices
        await LoadCustomersAndProducts();
    }

    private async Task LoadCustomersAndProducts()
    {
        try
        {
            // Load customers from service
            customers = await CustomerService.GetAllCustomersAsync();

            // Load products from service
            products = await ProductService.GetAllProductsAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading customers and products: {ex.Message}");
            
            // Fallback to sample data if services fail
            customers = new List<CustomerDto>
            {
                new CustomerDto { Id = 1, Name = "Acme Corporation", CompanyName = "Acme Corporation" },
                new CustomerDto { Id = 2, Name = "Global Industries", CompanyName = "Global Industries" },
                new CustomerDto { Id = 3, Name = "Tech Solutions", CompanyName = "Tech Solutions" },
                new CustomerDto { Id = 4, Name = "City Services", CompanyName = "City Services" }
            };

            products = new List<ProductDto>
            {
                new ProductDto { Id = 1, Name = "Consulting Services", UnitPrice = 150.00m },
                new ProductDto { Id = 2, Name = "Software License", UnitPrice = 500.00m },
                new ProductDto { Id = 3, Name = "Training Program", UnitPrice = 250.00m },
                new ProductDto { Id = 4, Name = "Support Services", UnitPrice = 100.00m },
                new ProductDto { Id = 5, Name = "Custom Development", UnitPrice = 200.00m }
            };
        }
    }

    private void FilterInvoices()
    {
        filteredInvoices = invoices.Where(i => 
            (string.IsNullOrEmpty(searchTerm) || 
             i.InvoiceNumber.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
             i.CustomerName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)) &&
            (string.IsNullOrEmpty(selectedStatus) || i.Status.ToString() == selectedStatus) &&
            (string.IsNullOrEmpty(selectedCustomer) || i.CustomerId.ToString() == selectedCustomer) &&
            (fromDate == null || i.InvoiceDate >= fromDate) &&
            (toDate == null || i.InvoiceDate <= toDate)
        ).ToList();
    }

    private Dictionary<string, string> GetUniqueCustomers()
    {
        return invoices
            .GroupBy(i => i.CustomerId)
            .ToDictionary(g => g.Key.ToString(), g => g.First().CustomerName);
    }

    private void CreateNewInvoice()
    {
        createInvoiceForm = new CreateInvoiceDto
        {
            InvoiceDate = DateTime.Now,
            Items = new List<CreateInvoiceItemDto> { new CreateInvoiceItemDto { Quantity = 1, UnitPrice = 0, TaxRate = 0 } }
        };
        showCreateModal = true;
    }

    private void CloseCreateModal()
    {
        showCreateModal = false;
        createInvoiceForm = new CreateInvoiceDto();
    }

    private async Task SaveInvoice()
    {
        try
        {
            // Call the backend service to create the invoice
            var createdInvoice = await InvoiceService.CreateInvoiceAsync(createInvoiceForm);
            
            // Reload invoices to show the new one
            await LoadInvoices();
            
            CloseCreateModal();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error creating invoice: {ex.Message}");
            // You could add error handling UI here
        }
    }

    private Dictionary<int, string> GetCustomerOptions()
    {
        return customers.ToDictionary(c => c.Id, c => c.Name);
    }

    private Dictionary<int, string> GetProductOptions()
    {
        return products.ToDictionary(p => p.Id, p => $"{p.Name} - {p.SalesPrice:C}");
    }

    private void AddInvoiceItem()
    {
        createInvoiceForm.Items.Add(new CreateInvoiceItemDto { Quantity = 1, UnitPrice = 0, TaxRate = 0 });
    }

    private void RemoveInvoiceItem(int index)
    {
        if (createInvoiceForm.Items.Count > 1)
        {
            createInvoiceForm.Items.RemoveAt(index);
        }
    }

    private void UpdateItemQuantity(int index, ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int quantity))
        {
            createInvoiceForm.Items[index].Quantity = Math.Max(1, quantity);
        }
        StateHasChanged();
    }

    private void UpdateItemPrice(int index, ChangeEventArgs e)
    {
        if (decimal.TryParse(e.Value?.ToString(), out decimal price))
        {
            createInvoiceForm.Items[index].UnitPrice = Math.Max(0, price);
        }
        StateHasChanged();
    }

    private void UpdateItemTaxRate(int index, ChangeEventArgs e)
    {
        if (decimal.TryParse(e.Value?.ToString(), out decimal taxRate))
        {
            createInvoiceForm.Items[index].TaxRate = Math.Max(0, Math.Min(100, taxRate));
        }
        StateHasChanged();
    }

    private void UpdateProductSelection(int index, ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int productId) && productId > 0)
        {
            var product = products.FirstOrDefault(p => p.Id == productId);
            if (product != null)
            {
                createInvoiceForm.Items[index].Description = product.Name;
                createInvoiceForm.Items[index].UnitPrice = product.SalesPrice > 0 ? product.SalesPrice : product.UnitPrice;
                createInvoiceForm.Items[index].TaxRate = product.TaxRate;
            }
        }
        else
        {
            // Clear fields if no product selected
            createInvoiceForm.Items[index].Description = string.Empty;
            createInvoiceForm.Items[index].UnitPrice = 0;
            createInvoiceForm.Items[index].TaxRate = 0;
        }
        StateHasChanged();
    }

    private void UpdateEditProductSelection(int index, ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int productId) && productId > 0)
        {
            var product = products.FirstOrDefault(p => p.Id == productId);
            if (product != null)
            {
                editForm.Items[index].Description = product.Name;
                editForm.Items[index].UnitPrice = product.SalesPrice > 0 ? product.SalesPrice : product.UnitPrice;
            }
        }
        else
        {
            // Clear fields if no product selected
            editForm.Items[index].Description = string.Empty;
            editForm.Items[index].UnitPrice = 0;
        }
        StateHasChanged();
    }

    private decimal GetItemTotal(CreateInvoiceItemDto item)
    {
        var subTotal = item.Quantity * item.UnitPrice;
        var taxAmount = subTotal * (item.TaxRate / 100);
        return subTotal + taxAmount;
    }

    private decimal GetInvoiceTotal()
    {
        return createInvoiceForm.Items.Sum(item => GetItemTotal(item));
    }

    private void AddEditInvoiceItem()
    {
        editForm.Items.Add(new EditInvoiceItemDto { Quantity = 1, UnitPrice = 0 });
    }

    private void RemoveEditInvoiceItem(int index)
    {
        if (editForm.Items.Count > 1)
        {
            editForm.Items.RemoveAt(index);
        }
    }

    private void UpdateEditItemQuantity(int index, ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int quantity))
        {
            editForm.Items[index].Quantity = Math.Max(1, quantity);
        }
        StateHasChanged();
    }

    private void UpdateEditItemPrice(int index, ChangeEventArgs e)
    {
        if (decimal.TryParse(e.Value?.ToString(), out decimal price))
        {
            editForm.Items[index].UnitPrice = Math.Max(0, price);
        }
        StateHasChanged();
    }

    private decimal GetEditInvoiceTotal()
    {
        var subTotal = editForm.Items.Sum(item => item.Quantity * item.UnitPrice);
        var taxAmount = subTotal * 0.08m; // 8% tax
        return subTotal + taxAmount;
    }

    private void ViewInvoice(int invoiceId)
    {
        viewInvoice = invoices.FirstOrDefault(i => i.Id == invoiceId);
        if (viewInvoice != null)
        {
            showViewModal = true;
        }
    }

    private void EditInvoice(int invoiceId)
    {
        var invoice = invoices.FirstOrDefault(i => i.Id == invoiceId);
        if (invoice != null)
        {
            editForm = new EditInvoiceDto
            {
                Id = invoice.Id,
                InvoiceNumber = invoice.InvoiceNumber,
                CustomerId = invoice.CustomerId,
                InvoiceDate = invoice.InvoiceDate,
                Description = invoice.Description,
                Notes = invoice.Notes,
                Status = invoice.Status,
                Items = invoice.Items.Select(item => new EditInvoiceItemDto
                {
                    ProductId = item.ProductId,
                    Description = item.Description,
                    Quantity = item.Quantity,
                    UnitPrice = item.UnitPrice
                }).ToList()
            };
            showEditModal = true;
        }
    }

    private void RecordPayment(int invoiceId)
    {
        selectedInvoice = invoices.First(i => i.Id == invoiceId);
        paymentForm = new CreatePaymentDto
        {
            PaymentDate = DateTime.Today,
            Amount = selectedInvoice.BalanceAmount,
            InvoiceId = invoiceId,
            CustomerId = selectedInvoice.CustomerId,
            PaymentMethod = PaymentMethod.BankTransfer
        };
        showPaymentModal = true;
    }

    private void ClosePaymentModal()
    {
        showPaymentModal = false;
        selectedInvoice = null;
        paymentForm = new CreatePaymentDto();
    }

    private async Task SavePayment()
    {
        if (selectedInvoice != null)
        {
            // Update invoice with payment
            selectedInvoice.PaidAmount += paymentForm.Amount;
            selectedInvoice.BalanceAmount -= paymentForm.Amount;
            
            if (selectedInvoice.BalanceAmount <= 0)
            {
                selectedInvoice.Status = InvoiceStatus.Paid;
            }
            else if (selectedInvoice.PaidAmount > 0)
            {
                selectedInvoice.Status = InvoiceStatus.PartiallyPaid;
            }
            
            FilterInvoices();
        }
        
        ClosePaymentModal();
    }

    private void CloseViewModal()
    {
        showViewModal = false;
        viewInvoice = null;
    }

    private void CloseEditModal()
    {
        showEditModal = false;
        editForm = new EditInvoiceDto();
    }

    private async Task SaveEditedInvoice()
    {
        var invoice = invoices.FirstOrDefault(i => i.Id == editForm.Id);
        if (invoice != null)
        {
            // Update invoice with edited data
            var customer = customers.FirstOrDefault(c => c.Id == editForm.CustomerId);
            invoice.CustomerId = editForm.CustomerId;
            invoice.CustomerName = customer?.Name ?? "Unknown Customer";
            invoice.InvoiceDate = editForm.InvoiceDate;
            invoice.Description = editForm.Description;
            invoice.Notes = editForm.Notes;
            invoice.Status = editForm.Status;
            
            // Recalculate totals
            var subTotal = editForm.Items.Sum(item => item.Quantity * item.UnitPrice);
            var taxAmount = subTotal * 0.08m; // 8% tax
            invoice.SubTotal = subTotal;
            invoice.TaxAmount = taxAmount;
            invoice.TotalAmount = subTotal + taxAmount;
            invoice.BalanceAmount = invoice.TotalAmount - invoice.PaidAmount;
            
            // Update items
            invoice.Items = editForm.Items.Select(item => new InvoiceItemDto
            {
                ProductId = item.ProductId,
                ProductName = products.FirstOrDefault(p => p.Id == item.ProductId)?.Name ?? "Custom Item",
                Description = item.Description,
                Quantity = item.Quantity,
                UnitPrice = item.UnitPrice,
                TotalPrice = item.Quantity * item.UnitPrice,
                LineTotal = item.Quantity * item.UnitPrice,
                TaxRate = 0.08m // 8% tax rate
            }).ToList();
            
            FilterInvoices();
        }
        
        CloseEditModal();
    }

    private async void PrintInvoice(int invoiceId)
    {
        try
        {
            Console.WriteLine($"PrintInvoice called for invoice ID: {invoiceId}");
            var invoice = await InvoiceService.GetInvoiceByIdAsync(invoiceId);
            if (invoice == null) 
            {
                Console.WriteLine("Invoice not found");
                return;
            }

            Console.WriteLine($"Invoice found: {invoice.InvoiceNumber}");
            var invoiceHtml = GenerateInvoiceHtml(invoice);
            Console.WriteLine($"Generated HTML length: {invoiceHtml.Length}");
            
            // Check if JavaScript function exists
            var jsExists = await JSRuntime.InvokeAsync<bool>("eval", new object[] { "typeof window.printUtils !== 'undefined' && typeof window.printUtils.printInvoice === 'function'" });
            Console.WriteLine($"JavaScript function exists: {jsExists}");
            
            if (jsExists)
            {
                await JSRuntime.InvokeAsync<object>("printUtils.printInvoice", new object[] { invoiceHtml });
                Console.WriteLine("JavaScript function called successfully");
            }
            else
            {
                Console.WriteLine("JavaScript function not found");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error printing invoice: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
        }
    }

    private async void TestJavaScript()
    {
        try
        {
            Console.WriteLine("Testing JavaScript...");
            var jsExists = await JSRuntime.InvokeAsync<bool>("eval", new object[] { "typeof window.printUtils !== 'undefined'" });
            Console.WriteLine($"printUtils exists: {jsExists}");
            
            if (jsExists)
            {
                await JSRuntime.InvokeAsync<object>("printUtils.testFunction", Array.Empty<object>());
            }
            else
            {
                Console.WriteLine("printUtils not found");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error testing JavaScript: {ex.Message}");
        }
    }

    private string GenerateInvoiceHtml(InvoiceDto invoice)
    {
        var html = "<div class='header'>" +
                   "<h1>INVOICE</h1>" +
                   "<h2>#" + invoice.InvoiceNumber + "</h2>" +
                   "</div>" +
                   "<div class='invoice-details'>" +
                   "<table>" +
                   "<tr><td><strong>Customer:</strong></td><td>" + invoice.CustomerName + "</td><td><strong>Invoice Date:</strong></td><td>" + invoice.InvoiceDate.ToString("MMMM dd, yyyy") + "</td></tr>" +
                   "<tr><td><strong>Status:</strong></td><td>" + invoice.Status + "</td><td><strong>Due Date:</strong></td><td>" + invoice.DueDate.ToString("MMMM dd, yyyy") + "</td></tr>" +
                   "</table>" +
                   "</div>" +
                   "<table class='items-table'>" +
                   "<thead>" +
                   "<tr>" +
                   "<th>Description</th>" +
                   "<th>Qty</th>" +
                   "<th>Unit Price</th>" +
                   "<th>Tax Rate</th>" +
                   "<th>Total</th>" +
                   "</tr>" +
                   "</thead>" +
                   "<tbody>";

        foreach (var item in invoice.Items)
        {
            html += "<tr>" +
                    "<td>" + item.Description + "</td>" +
                    "<td>" + item.Quantity + "</td>" +
                    "<td>" + item.UnitPrice.ToString("C") + "</td>" +
                    "<td>" + item.TaxRate.ToString("P") + "</td>" +
                    "<td>" + item.TotalPrice.ToString("C") + "</td>" +
                    "</tr>";
        }

        html += "</tbody>" +
                "</table>" +
                "<div class='total'>" +
                "<p><strong>Subtotal: " + invoice.SubTotal.ToString("C") + "</strong></p>" +
                "<p><strong>Tax: " + invoice.TaxAmount.ToString("C") + "</strong></p>" +
                "<p><strong>Discount: " + invoice.DiscountAmount.ToString("C") + "</strong></p>" +
                "<p><strong>Total: " + invoice.TotalAmount.ToString("C") + "</strong></p>" +
                "<p><strong>Paid: " + invoice.PaidAmount.ToString("C") + "</strong></p>" +
                "<p><strong>Balance Due: " + invoice.BalanceAmount.ToString("C") + "</strong></p>" +
                "</div>";

        if (!string.IsNullOrEmpty(invoice.Notes))
        {
            html += "<div style='margin-top: 20px;'>" +
                    "<strong>Notes:</strong><br>" +
                    invoice.Notes +
                    "</div>";
        }

        return html;
    }

    private void DeleteInvoice(int invoiceId)
    {
        if (confirm("Are you sure you want to delete this invoice?"))
        {
            invoices.RemoveAll(i => i.Id == invoiceId);
            FilterInvoices();
        }
    }

    private bool confirm(string message)
    {
        // In a real app, you'd use a proper confirmation dialog
        return true;
    }

    private string GetStatusClass(InvoiceStatus status)
    {
        return status switch
        {
            InvoiceStatus.Draft => "secondary",
            InvoiceStatus.Sent => "info",
            InvoiceStatus.Paid => "success",
            InvoiceStatus.PartiallyPaid => "warning",
            InvoiceStatus.Overdue => "danger",
            InvoiceStatus.Cancelled => "dark",
            _ => "secondary"
        };
    }
}
